{% load i18n %}

<div class="ui search">
    <input class="prompt" placeholder="{% trans "Search places" %}"
        type="{{ widget.type }}" name="{{ widget.name }}"
        {% if widget.value != None %} value="{{ widget.value|stringformat:'s' }}" {% endif %}
        {% for name, value in widget.attrs.items %}{% if value is not False %}
            {{ name }}{% if value is not True %}="{{ value|stringformat:'s' }}"{% endif %}{% endif %}{% endfor %}>
        {# Could not find how to include django default widget template that does this #}
    <div class="results" style="width: 100%;"></div>
</div>

<script>
    $('input[name={{ widget.name }}]').parent().search({
        searchDelay: 0,
        fullTextSearch: true,
        apiSettings: {
            // Search for points of interest at given campus
            url: 'https://api.mazemap.com/search/equery/?q={query}&withpois=true' +
                '&rows={{ widget.max_results }}' +
                '&campusid={{ widget.campus_id }}',

            // Convert mazemap search results to fit semantic ui search format
            onResponse: (mazemap_response => ({
                results: mazemap_response.result.map(item => ({
                    title: (
                        item.dispPoiNames[0] +
                        (item.dispBldNames[0] ? ", " + item.dispBldNames[0] : "")
                    ).replace(/<[/]?em>/g, ""),
                    description: (item.dispPoiNames[1] ? item.dispPoiNames[1] : "").replace(/<[/]?em>/g, ""),
                    id: item.poiId,
                }))
            })),
        },
        {% if widget.url_field %}
            onSelect: function (result, response) {
                $("input[name={{ widget.url_field }}]").val(
                    `https://use.mazemap.com/?campusid={{ widget.campus_id }}&desttype=poi&dest=${result.id}`
                );
            },
        {% endif %}
    });
</script>
