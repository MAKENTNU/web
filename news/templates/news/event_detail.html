{% extends 'news/news_base_detail.html' %}
{% load static %}
{% load i18n %}
{% load datetime_tags %}
{% load event_tags %}


{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'news/css/event_detail.css' %}"/>
{% endblock extra_head %}

{% block extra_classes %}left-align{% endblock extra_classes %}

{% block admin_page %}
    {% if perms.news.change_event %}
        <div>
            <a class="ui make-bg-yellow button" href="{% url 'admin_event_detail' news_obj.pk %}">
                <i class="sticky note icon"></i>{% trans "Admin page" %}
            </a>
            {% if news_obj.number_of_tickets > 0 and perms.news.change_event %}
                <a class="grey link text" href="{% url 'event_ticket_list' news_obj.pk %}">
                    <i class="ticket icon"></i>
                    {{ news_obj.number_of_active_tickets }} / {{ news_obj.number_of_tickets }}
                </a>
            {% endif %}
        </div>
    {% endif %}
{% endblock admin_page %}


{% block rail %}
    <div class="time-places ui right attached rail">
        {% if is_old %}
            <div class="ui info message">
                {% trans "You are viewing an old event" %}.
                {% if last_occurrence %}
                    {% trans "The last occurrence of this event was" %} {{ last_occurrence.start_time|short_date }}
                {% endif %}
            </div>
        {% endif %}
        <div class="ui sticky rail-content">
            {% for occurrence in timeplaces %}
                <div class="ui card">
                    <div class="content">
                        <i class="make-col-yellow wait icon"></i>
                        {% if occurrence.start_time.date == occurrence.end_time.date %}
                            {{ occurrence.start_time|year_wise_long_date }}
                        {% else %}
                            {{ occurrence.start_time|year_wise_long_date }} {{ occurrence.start_time|only_time }}
                        {% endif %}
                        <br/>
                        {# Hidden icon only for indenting to the same level as the icon above #}
                        <i class="hidden wait icon"></i>
                        {% if occurrence.start_time.date == occurrence.end_time.date %}
                            {{ occurrence.start_time|only_time }}
                            &ndash; {{ occurrence.end_time|only_time }}
                        {% else %}
                            &ndash;&nbsp; {{ occurrence.end_time|year_wise_long_date }} {{ occurrence.end_time|only_time }}
                        {% endif %}
                        {% if occurrence.place %}
                            <div class="place">
                                <i class="make-col-yellow map marker alternate icon"></i>
                                {% if occurrence.place_url %}
                                    <a class="make-col-blue" href="{{ occurrence.place_url }}" target="_blank">
                                        {{ occurrence.place }}
                                    </a>
                                {% else %}
                                    {{ occurrence.place }}
                                {% endif %}
                            </div>
                        {% endif %}

                        <a class="calendar-link" href="{% url 'timeplace_ical' news_obj.pk occurrence.pk %}" target="_blank">
                            <i class="large make-col-yellow calendar outline icon"></i>
                        </a>

                        {% if occurrence.number_of_tickets > 0 and perms.news.change_event %}
                            <div class="right floated meta">
                                <a href="{% url 'timeplace_ticket_list' news_obj.pk occurrence.pk %}">
                                    <i class="ticket icon"></i>
                                    {{ occurrence.number_of_active_tickets }} / {{ occurrence.number_of_tickets }}
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    {% if occurrence.event.repeating %}
                        {% if occurrence.number_of_tickets > 0 %}
                            {% get_ticket occurrence user as ticket %}
                            {% if ticket %}
                                <a class="ui green bottom attached button" href="{% url 'ticket_detail' ticket.pk %}">
                                    {% trans "You are registered for this event" %}
                                </a>
                            {% elif occurrence.number_of_active_tickets < occurrence.number_of_tickets %}
                                <a class="ui make-bg-yellow bottom attached button"
                                   href="{% url 'register_timeplace' news_obj.pk occurrence.pk %}">
                                    {% trans "Registration" %}
                                </a>
                            {% else %}
                                <p class="ui disabled bottom attached button">
                                    {% trans "Sold out" %}
                                </p>
                            {% endif %}
                        {% else %}
                            <p class="ui disabled bottom attached button">
                                {% trans "No registration" %}
                            </p>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
            {% if news_obj.standalone and news_obj.timeplaces.future %}
                <div class="ui card">
                    {% if news_obj.number_of_tickets > 0 %}
                        {% get_ticket news_obj user as ticket %}
                        {% if ticket %}
                            <a class="ui green button" href="{% url 'ticket_detail' ticket.pk %}">
                                {% trans "You are registered for this event" %}
                            </a>
                        {% elif news_obj.number_of_active_tickets < news_obj.number_of_tickets %}
                            <a class="ui make-bg-yellow button" href="{% url 'register_event' news_obj.pk %}">
                                {% trans "Registration" %}
                            </a>
                        {% else %}
                            <p class="ui disabled button">
                                {% trans "Sold out" %}
                            </p>
                        {% endif %}
                    {% else %}
                        <p class="ui disabled button">
                            {% trans "No registration" %}
                        </p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
{% endblock rail %}


{% block accordion %}
    <div class="time-places accordion">

        <div class="accordion-padding"></div>

        {% if is_old %}
            <div class="ui info message">
                {% trans "You are viewing an old event" %}.
                {% if last_occurrence %}
                    {% trans "The last occurrence of this event was" %} {{ last_occurrence.start_time|short_date }}
                {% endif %}
            </div>
        {% endif %}
        {% if news_obj.standalone and news_obj.timeplaces.future %}
            <div>
                {% if news_obj.number_of_tickets > 0 %}
                    {% get_ticket news_obj user as ticket %}
                    {% if ticket %}
                        <a class="ui green fluid button" href="{% url 'ticket_detail' ticket.pk %}">
                            {% trans "You are registered for this event" %}
                        </a>
                    {% elif news_obj.number_of_active_tickets < news_obj.number_of_tickets %}
                        <a class="ui make-bg-yellow fluid button" href="{% url 'register_event' news_obj.pk %}">
                            {% trans "Registration" %}
                        </a>
                    {% else %}
                        <p class="ui disabled fluid button">
                            {% trans "Sold out" %}
                        </p>
                    {% endif %}
                {% else %}
                    <p class="ui disabled fluid button">
                        {% trans "No registration" %}
                    </p>
                {% endif %}
            </div>
        {% endif %}

        <div class="ui styled accordion">
            {% for occurrence in timeplaces %}
                <div class="title">
                    <i class="dropdown icon"></i>
                    {{ occurrence.start_time|year_wise_long_date }}
                </div>
                <div class="content">
                    <div class="transition hidden">
                        <div class="ui card">
                            <div class="content">
                                <div>
                                    <i class="make-col-yellow wait icon"></i>
                                    {% if occurrence.start_time.date == occurrence.end_time.date %}
                                        {{ occurrence.start_time|only_time }} &ndash; {{ occurrence.end_time|only_time }}
                                    {% else %}
                                        {{ occurrence.start_time|year_wise_long_date }} {{ occurrence.start_time|only_time }}
                                        <br/>
                                        {# Hidden icon only for indenting to the same level as the icon above #}
                                        <i class="hidden wait icon"></i>
                                        &ndash;&nbsp; {{ occurrence.end_time|year_wise_long_date }} {{ occurrence.end_time|only_time }}
                                    {% endif %}
                                </div>
                                {% if occurrence.place %}
                                    <div class="place">
                                        <i class="make-col-yellow map marker alternate icon"></i>
                                        {% if occurrence.place_url %}
                                            <a class="make-col-blue" href="{{ occurrence.place_url }}" target="_blank">
                                                {{ occurrence.place }}
                                            </a>
                                        {% else %}
                                            {{ occurrence.place }}
                                        {% endif %}
                                    </div>
                                {% endif %}

                                <a class="calendar-link" href="{% url 'timeplace_ical' news_obj.pk occurrence.pk %}" target="_blank">
                                    <i class="large make-col-yellow calendar outline icon"></i>
                                </a>

                                {% if occurrence.number_of_tickets > 0 and perms.news.change_event %}
                                    <div class="right floated meta">
                                        <a href="{% url 'timeplace_ticket_list' news_obj.pk occurrence.pk %}">
                                            <i class="ticket icon"></i>
                                            {{ occurrence.number_of_active_tickets }} / {{ occurrence.number_of_tickets }}
                                        </a>
                                    </div>
                                {% endif %}
                            </div>

                            {% if occurrence.event.repeating %}
                                {% if occurrence.number_of_tickets > 0 %}
                                    {% get_ticket occurrence user as ticket %}
                                    {% if ticket %}
                                        <a class="ui green bottom attached button" href="{% url 'ticket_detail' ticket.pk %}">
                                            {% trans "You are registered for this event" %}
                                        </a>
                                    {% elif occurrence.number_of_active_tickets < occurrence.number_of_tickets %}
                                        <a class="ui make-bg-yellow bottom attached button"
                                           href="{% url 'register_timeplace' news_obj.pk occurrence.pk %}">
                                            {% trans "Registration" %}
                                        </a>
                                    {% else %}
                                        <p class="ui disabled bottom attached button">
                                            {% trans "Sold out" %}
                                        </p>
                                    {% endif %}
                                {% else %}
                                    <p class="ui disabled bottom attached button">
                                        {% trans "No registration" %}
                                    </p>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <script>$(".ui.accordion").accordion('open', 0);</script>

    </div>
{% endblock accordion %}


{% block extra_scripts %}
    {{ block.super }}
    <script>
        {% comment %}
            Fomantic-UI sticky does not adjust the height of the context element when the sticky part is taller. In the
            cases where this needs to be done, we must make sure that the change is performed after Fomantic-UI has
            performed their own changes. Hopefully this will be fixed at some point in Fomantic-UI, and we can remove
            this stopgap solution. In most cases, the solution will not be needed, as the average number of occurrences
            is low enough that the event content is taller than the sticky part.
        {% endcomment %}

        $(document).ready(function () {
            // Use a timeout of 50 to make sure that the Fomantic-UI code is finished
            setTimeout(() => {
                const $sticky = $(".ui.sticky.rail-content");
                const $context = $("#sticky");

                function fixHeight() {
                    // If the height of the sticky is greater than the context (the event content), then increase the
                    // height of the event to be equal (that is, the sticky is simply a single scroll).
                    if ($sticky.height() > $context.height()) {
                        $context.height(`${$sticky.height()}px`);
                    }
                }

                // The sticky code resets the height on each resizing of the window. Thus, the change must be performed
                // each time the window is resized. To catch any other cases as well, we use the "onReposition" action.
                $sticky.sticky("setting", "onReposition", () => {
                    // Use a timeout of 50 to make sure that the Fomantic-UI code is finished
                    setTimeout(fixHeight, 50);
                });
                fixHeight();
            }, 50);
        });
    </script>
{% endblock extra_scripts %}
