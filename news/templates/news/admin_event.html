{% extends "web/base.html" %}
{% load i18n %}
{% load news_tags %}
{% load staticfiles %}

{% block head %}
    <link rel="stylesheet" href="{% static "news/css/admin-event.css" %}">
{% endblock %}

{% block body %}

    <div class="ui container">
        <h1><a href="{% url "event" object.id %}">{{ object.title }}</a></h1>

        <div class="ui info {% if not object.hidden %}hidden{% endif %} message" id="message-hidden">
            <div class="header">
                {% trans "Hidden event" %}
            </div>
            {% trans "This event is hidden! Non-admin users will not be able to see the event or its occurrences." %}
        </div>
        <div class="ui info {% if not object.featured %}hidden{% endif %} message" id="message-featured">
            <div class="header">
                {% trans "Featured event" %}
            </div>
            {% trans "This event is featured! Any future occurrences may be shown on the front page." %}
        </div>
        <div class="ui info {% if not object.private %}hidden{% endif %} message" id="message-private">
            <div class="header">
                {% trans "Private event" %}
            </div>
            {% trans "This event is private! It is only visible to members of MAKE NTNU." %}
        </div>

        <div>
            <h1>
                <i class="ui {{ object.featured|color }} star icon toggle explanation-popup"
                   data-title="{% trans "Feature" %}"
                   data-content="{% trans "If selected, the event is shown on the front page." %}"
                   data-pk="{{ object.pk }}" data-toggle="featured" data-model="event"></i>
                <i class="ui {{ event.hidden|color }} eye slash icon toggle explanation-popup"
                   data-title="{% trans "Hidden" %}"
                   data-content="{% trans "If selected, the event is hidden for non-admin users." %}"
                   data-pk="{{ object.pk }}" data-toggle="hidden" data-model="event"></i>
                <img class="makeicon toggle explanation-popup"
                     data-title="{% trans "Internal" %}"
                     data-content="{% trans "If selected, the event is only available for MAKE members." %}"
                        {% if event.private %}
                     src="{% static "web/img/m_yellow.svg" %}"
                        {% else %}
                     src="{% static "web/img/m_grey.svg" %}"
                        {% endif %}
                     data-pk="{{ object.pk }}" data-toggle="private" data-model="event">
                {% if perms.news.change_event %}
                    <a class="inline-block make_col_blue explanation-popup"
                       data-title="{% trans "Edit" %}"
                       data-content="{% trans "If clicked, a form for editing the event is shown." %}"
                       href="{% url 'event-edit' event.id %}">
                        <i class="ui edit icon"></i>
                    </a>
                {% endif %}
                {% if perms.news.delete_event %}
                    <a class="delete confirm inline-block make_col_blue explanation-popup"
                       data-title="{% trans "Delete" %}"
                       data-content="{% trans "If clicked, the event will be deleted." %}"
                       href="{% url 'event-delete' event.id %}">
                        <i class="ui delete icon"></i>
                    </a>
                {% endif %}
                {% if perms.news.add_timeplace %}
                    <a class="inline-block make_col_blue explanation-popup"
                       data-title="{% trans "Occurrence" %}"
                       data-content="{% trans "If clicked, creates a new occurrence of the event" %}"
                       href="{% url 'timeplace-new' event.id %}">
                        <i class="icons">
                            <i class="time icon"></i>
                            <i class="noshadow bottom right corner add icon"></i>
                        </i>
                    </a>
                {% endif %}
            </h1>
        </div>

        <h2>{% trans "Occurrences" %}</h2>
        <div class="ui tabular pointing secondary menu">
            <a class="active item" data-tab="future">{% trans "Future" %}
                <div class="ui blue label">{{ object.timeplace_set|future|length }}</div>
            </a>
            <a class="item" data-tab="past">{% trans "Past" %}
                <div class="ui red label">{{ object.timeplace_set|past|length }}</div>
            </a>
        </div>

        <div class="ui active tab segment" data-tab="future">
            <div class="ui list">
                {% for timeplace in object.timeplace_set|future %}
                    {% include "news/admin_timeplace_listing.html" %}
                {% empty %}
                    {% trans "No future occurrences exist for this event" %}
                {% endfor %}
            </div>
        </div>
        <div class="ui bottom attached tab segment" data-tab="past">
            <div class="ui list">
                {% for timeplace in object.timeplace_set|past %}
                    {% include "news/admin_timeplace_listing.html" %}
                {% empty %}
                    {% trans "No past occurrences exist for this event" %}
                {% endfor %}
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        $(".tabular.menu .item").tab();
        $(".explanation-popup").popup();

        $('.toggle').click(function () {
            toggle_post($(this), $(this).data('pk'), $(this).data('model'), $(this).data('toggle'));
        });

        function toggle_post(element, pk, model, toggle) {
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            });
            $.ajax({
                type: "POST",
                url: '/news/admin/toggle/' + model + '/',
                data: {
                    'pk': pk,
                    'toggle': toggle,
                },
                success: function (data) {
                    if (!data['color']) {
                        return;
                    }
                    if (toggle === 'private') {
                        if (data['color'] === 'yellow') {
                            element.attr('src', '{% static "web/img/m_yellow.svg" %}');
                        } else {
                            element.attr('src', '{% static "web/img/m_grey.svg" %}');
                        }
                    } else {
                        element.removeClass('yellow grey').addClass(data['color']);
                    }

                    if (model === "event") {
                        $("#message-" + toggle).toggleClass("hidden", data["color"] === "grey")
                    }
                }
            });
        }
    </script>
{% endblock %}