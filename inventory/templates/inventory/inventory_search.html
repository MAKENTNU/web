{% extends "web/base.html" %}
{% load staticfiles %}
{% load thumbnail %}
{% load i18n %}

{% block head %}
    <link rel="stylesheet" type="text/css" href="{% static "inventory/css/inventory.css" %}">
{% endblock head %}

{% block body %}

    {#    {% include "inventory/treemenu.html" %}#}


    <div class="ui container text-centered">
        <div class="five wide field">
            <select id="item-dropdown" class="ui fluid dropdown search" name="items">
                <option value="">{% trans "Select/search" %}</option>
{#                {% for item in items %}#}
{#                    <option value="{{ item.name }}">{{ item.name }}</option>#}
{#                {% endfor %}#}
            </select>
        </div>

{#        <div class="ui category search">#}
{#            <div class="ui icon input">#}
{#                <input id="item-search" class="prompt" type="text" placeholder="Item...">#}
{#                <i class="search icon"></i>#}
{#            </div>#}
{#            <div class="results"></div>#}
{#        </div>#}
        <p id="test-field"></p>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        let last_entry = "";

        $('.dropdown').dropdown();


        $('.ui.dropdown').keyup(function (event) {
            let current_entry = $('#item-dropdown').siblings('input.search').val();
            let key_code = event.keyCode;
            if (current_entry !== last_entry || key_code === '13') {
                get_search_query($(this), current_entry);
            }
            last_entry = current_entry;
        });


        function get_search_query(element, search) {
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
            });
            $.ajax({
                type: "POST",
                url: 'search',
                data: {
                    'search': search,
                },
                success: function (data) {
                    if (data['item_names']) {
                        let item_names = data['item_names'];
                        let content = [];
                        $('#item-dropdown').children('option').remove();
                        $('#item-dropdown').append('<option value="">{% trans "Select/search" %}</option>');
                        for (let i = 0; i < Math.min(10, item_names.length); i++) {
                            let name = item_names[i];
                            let html = `<option value=\"${name}\">${name}</option>`;

                            $('#item-dropdown').append(html);
                        }
                    }
                    {#if (data['is_forced']) {#}
                    {#    element.parents('tr').remove();#}

                    {#element.addClass('green');#}
                    {#element.addClass('disabled');#}
                    {#element.html('{% trans "Voted!" %}');#}
                    {##}
                    {#if (!data['user_exists']) {#}
                    {#    let incrementedCount = parseInt(element.parent().siblings('#vote-count').html()) + 1;#}
                    {#    element.parent().siblings('#vote-count').html(incrementedCount);#}

                    {#if (data['skill_passed']) {#}
                    {#    element.parents('tr').remove();#}

                },
            });
        }

    </script>
{% endblock scripts %}
