{% load reservation_extra %}
{% load staticfiles %}
{% load l10n %}

{% localize off %}

    <link rel="stylesheet" href="{% static 'make_queue/css/calendar.css' %}">

    <div class="attached ui buttons">
        <a class="ui labeled icon make_yellow button" id="prev_week_button"
           {% if link_prev %}href="{{ link_prev }}"{% endif %}>
            <i class="left chevron icon"></i>
            Forrige
        </a>
        <a class="ui make_yellow button bordered"
           id="now_button" {% if link_now %}href="{{ link_now }}"{% endif %}>
            <i class="calendar icon"></i>
            NÃ¥ (Uke {{ now.date|date:"W" }})
        </a>
        <a class="ui right labeled icon make_yellow button" id="next_week_button"
           {% if link_next %}href="{{ link_next }}"{% endif %}>
            <i class="right chevron icon"></i>
            Neste
        </a>
    </div>
    <table class="ui celled fixed very compact unstackable table">
        <thead>
        <tr>
            <th class="make_reservation_calendar_short_month title_large">
                <div>{{ week_days.0.date|date:"b"|title }}</div>
                <div class="title_small">{{ week_days.0.date|date:"W" }}</div>
            </th>
            <th class="make_reservation_calendar_long_month title_large">
                <div>{{ week_days.0.date|date:"F"|title }}</div>
                <div class="title_small">Uke {{ week_days.0.date|date:"W" }}</div>
            </th>
            {% for day in week_days %}
                <th>
                    <div class="title_large">{{ day.date|date:"D"|title }}</div>
                    <div class="title_medium">{{ day.date|date:"j" }}</div>
                </th>
            {% endfor %}
        </tr>
        </thead>
        <tr>
            <td class="wrapping">
                <div class="half_height"></div>
                {% numeric_range 1 24 as hours %}
                {% for hour in hours %}
                    <div>{{ hour|stringformat:"02d" }}:00</div>
                {% endfor %}
                <div class="half_height"></div>
            </td>
            {% for day in week_days %}
                <td class="wrapping">
                    <div class="day" data-date="{{ day.date|date:"j.m.Y" }}" data-machine="{{ machine }}">
                        {% numeric_range 0 7 as num_indication_lines %}
                        {% for line in num_indication_lines %}
                            <div class="hour_indication_line"></div>
                        {% endfor %}
                        {% for reservation in day.reservations %}
                            {% if reservation.length %}
                                <div class="make_reservation_calendar_time_table_item
                                            {% if reservation.reservation.special %}
                                                make_reservation_calendar_time_table_make
                                            {% elif reservation.reservation.event %}
                                                make_reservation_calendar_time_table_event
                                            {% else %}
                                                {% if reservation.reservation.user == request.user %}
                                                    make_reservation_calendar_time_table_my_non_event
                                                {% else %}
                                                    make_reservation_calendar_time_table_non_event
                                                {% endif %}
                                            {% endif %}"
                                     style="top: {{ reservation.start_percentage }}%; height: {{ reservation.length }}%;"
                                        {% if reservation.reservation.special %}
                                     data-content="{{ reservation.reservation.special_text }}"
                                        {% elif perms.make_queue.can_view_reservation_user and not reservation.reservation.special %}
                                     data-html="<div class='header'>
                                                    Reservasjon
                                                </div>
                                                <div>
                                                    <b>Navn:</b> {{ reservation.reservation.user.get_full_name }}
                                                </div>
                                                <div>
                                                    <b>Epost:</b> {{ reservation.reservation.user.email }}
                                                </div>"
                                        {% endif %}>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </td>
            {% endfor %}
        </tr>
        <tfoot>
        <tr>
            <th colspan="8">
                <div class="make_reservation_calendar_legend make_right_floated">
                    <div class="make_reservation_calendar_legend_item">
                        <div class="make_reservation_calendar_legend_box make_reservation_calendar_time_table_make"></div>
                        MAKE NTNU
                    </div>
                    <div class="make_reservation_calendar_legend_item">
                        <div class="make_reservation_calendar_legend_box make_reservation_calendar_time_table_non_event"></div>
                        Andre Reservasjoner
                    </div>
                    <div class="make_reservation_calendar_legend_item">
                        <div class="make_reservation_calendar_legend_box make_reservation_calendar_time_table_event"></div>
                        Arrangementer
                    </div>
                    <div class="make_reservation_calendar_legend_item">
                        <div class="make_reservation_calendar_legend_box make_reservation_calendar_time_table_my_non_event"></div>
                        Mine Reservasjoner
                    </div>
                </div>
            </th>
        </tr>
        </tfoot>
    </table>

    <script>
        $(".make_reservation_calendar_time_table_item").popup();

        let clickedDay = null;
        let clickedPoint = 0;
        let selected = false;

        let zeroPadClock = (number) => ("00" + number).substr(-2, 2);
        let timeToClock = (time) =>
            time <= 0
                ? "00:00"
                : zeroPadClock(Math.floor(time)) + ":" + zeroPadClock(Math.floor(time % 1 * 60));

        let getStartTime = () => {
            return parseFloat($(".time_selection").css("top")) / $(".time_selection").closest(".day").height() * 24;
        };

        let getEndTime = () => {
            return (parseFloat($(".time_selection").css("top")) + $(".time_selection").height()) / $(".time_selection").closest(".day").height() * 24;
        };

        let onLetGoFunc = (event) => {
            if (clickedDay === event.target && !selected) {
                selected = true;
                let time_selection_element = $(".time_selection");
                let day = time_selection_element.closest(".day");

                time_selection_element.popup({
                    html: typeof timeSelectionPopupHTML !== "undefined"
                        ? timeSelectionPopupHTML(day.data("date"), timeToClock(getStartTime()), timeToClock(getEndTime()), day.data("machine"))
                        : () => "",
                    position: "right center",
                }).popup("show");
                $("body").mousedown((event) => {
                    if (!$(".popup").find(($(event.target))).length) {
                        $(".time_selection").remove();
                        clickedDay = null;
                        selected = false;
                        $("body").unbind("click");
                    }
                });
                return false;
            }
        };

        let onMouseDownFunc = (event) => {
            if (clickedDay === null) {
                event.preventDefault();
                clickedPoint = positionCalculation(event);
                clickedDay = event.target;
                let time_selection = $("<div>")
                    .addClass("time_selection")
                    .css("top", clickedPoint + "px")
                    .css("height", "1px")
                    .appendTo($(event.target));
                $("<div>")
                    .addClass("start_time")
                    .html(timeToClock(getStartTime()))
                    .appendTo(time_selection);
                $("<div>")
                    .addClass("end_time")
                    .html(timeToClock(getEndTime()))
                    .appendTo(time_selection);
                return false;
            }
        };

        let onMouseMoveFunc = (event) => {
            if (clickedDay === event.target && !selected) {
                let currentY = positionCalculation(event);
                if (currentY < clickedPoint) {
                    $(".time_selection").css("top", currentY + "px").css("height", (clickedPoint - currentY) + "px");
                } else {
                    $(".time_selection").css("top", clickedPoint + "px").css("height", (currentY - clickedPoint) + "px");
                }
                $(".time_selection > .start_time").html(timeToClock(getStartTime()));
                $(".time_selection > .end_time").html(timeToClock(getEndTime()));
            }
        };

        let positionCalculation = (event) => {
            if (event.touches === undefined) {
                return event.pageY - $(event.target).offset().top;
            }
            return event.touches[0].pageY - $(event.target).offset().top;
        };

        $(".day").on({
            "touchstart": onMouseDownFunc, "touchend": onLetGoFunc, "touchmove": onMouseMoveFunc,
            "mousedown": onMouseDownFunc, "mouseup": onLetGoFunc, "mousemove": onMouseMoveFunc,
        });
    </script>

{% endlocalize %}